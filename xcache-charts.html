<html>
<head>
	<style>
		.chart {
			width: 370px;
			height: 200px;
			float: left;
		}
	</style>
	<script language="javascript" type="text/javascript" src="/xcache/jquery.js"></script>  
	<script language="javascript" type="text/javascript" src="/xcache/highcharts.js"></script>  
	<script language="javascript" type="text/javascript" src="/xcache/socket.js"></script>  
	<script type="text/javascript">  

		function realtime_chart(title, ytitle, series) {
			$('.mainfrm').append("<div id='" + title + "' class=chart >");
			var t = new Highcharts.Chart({
				chart: { renderTo:title, type:'spline', animation:false },
				title: { text:title },
				xAxis: { type:'datetime', tickPixelInterval:200 },
				yAxis: { title: { text:ytitle } },
				series: series
			});
			ta.push(t);
		}

		function static_chart(title, ytitle, series) {
			$('.mainfrm').append("<div id='" + title + "' class=chart >");
			var t = new Highcharts.Chart({
				chart: { renderTo:title, type:'spline', animation:false },
				title: { text:title },
				xAxis: { type:'datetime', tickPixelInterval:200 },
				yAxis: { title: { text:ytitle } },
				series: series
			});
		}

		var ta = [];
		var t = (new Date()).getTime(), i, _d = [];
		for (i = 0; i < 30; i++) _d.push([t,0]);
		function D(s) { return {name:s, data:_d}; }


		function realtime() {
			realtime_chart('cpu-usage', '%', [D('c_all')]);
			realtime_chart('hd-usage', 'GB', [D('d_hd')]);
			realtime_chart('ssd-usage', 'GB', [D('d_ssd')]);
			realtime_chart('hash-count', 'count/s', [D('ht_active'), D('ht_max')]);
			realtime_chart('files', 'count/s', [
					D('f_done'), 
					//D('f_delsmall'), 
					//D('f_zio'), 
					//D('f_rst'),
					//D('f_reget')
			]);
			realtime_chart('network-io', 'Mb/s', [D('io_eth0'), D('io_eth1')]);
			realtime_chart('ssd-io', 'MB/s', [D('io_ssd')]);
			realtime_chart('http-jmps', 'count/s', [D('jmp_pass'), D('jmp_mine')]);
		}
		
		function conn_sock() { 
			io.connect('http://'+window.location.hostname+':8889')
				.on('news', function (data) {
					//console.log(data);
					var j = jQuery.parseJSON(data);
					for (t in ta) {
						var x = (new Date()).getTime();
						//console.log(ta[t].series);
						for (s in ta[t].series) {
							a = ta[t].series[s];
							for (i in j) {
								if (i == a.name) 
									a.addPoint([x, j[i]], true, true);
							}
						}}
				});
		}

		function show_capture() {
			$.ajax({
				url: '/xcache/cgi.pl?listc',
			}).done(function(d) {
				$('.mainfrm').html('<pre>'+d+'</pre>');
			});
				setTimeout(show_capture, 1000);
		}

		$(document).ready(function() { 
			qry = window.location.search;
			if (qry == '?realtime' || qry == '') {
				realtime();
				conn_sock();
			}
			if (qry == '?capture') {
				show_capture();
			}
		});
	</script>  
</head>
<body>  
	<div> 
		<a href="?realtime">Realtime </a> |
		<a href="?capture">Capture</a> |
		<!--
		<a href="?5min">5 Min</a> |
		<a href="?30min">30 Min</a> |
		<a href="?6h">6 Hour</a> |
		<a href="?1d">1 Day</a> |
		!-->
 	</div>
	<div class=mainfrm></div>
</body>  
</html>


#!/usr/bin/python

import marshal, os
from optparse import OptionParser
from xcache import *

def filesize(s):
	if s > 1024*1024:
		return '%.1fM'%(s/1024./1024.)
	elif s > 1024:
		return '%.1fK'%(s/1024.)
	return '%dB'%s

if __name__ == '__main__':
	parser = OptionParser()
	parser.add_option('-w', '--web', action="store_true", dest='w', help='show entrys in pretty HTML format')
	opt, args = parser.parse_args()
	if opt.w:
		print '<table border=1>'
		print '<tr>'
		print '<th>entry</th>'
		print '<th>stat</th>'
		print '<th>size</th>'
		print '<th>url</th>'
		print '<th>start</th>'
		print '<th>info</th>'
		print '<th>headers</th>'
		print '</tr>'
	for i in os.listdir(cache):
		m = XCacheInfo(cache+i+'/')
		if opt.w:
			print '<tr>'
			print '<th>%s</th>' % i
			c = {'error':'red', 'cached':'green', 'caching':'gray', 'processing':'yellow'}
			print '<th><font color=%s>%s</font></th>' % (c[m.stat], m.stat)
			print '<th>%s</th>' % filesize(os.path.getsize(m.short+'file'))
			print '<th>'
			print '<a href=%s>%s</a>' % ('/xcache/'+i+'/file'+m.ext, m.ext[1:])
			print '</th>'
			print '<th>%s</th>' % m.start
			print '<th>'
			print '<span>%s</span>' % (m.reason if m.stat == 'error' else '')
			print '</th>'
			print '<th>'
			print '<a href=%s>%s</a>' % ('/xcache/'+i+'/rsp.txt', 'rsp')
			print '<a href=%s>%s</a>' % ('/xcache/'+i+'/req.txt', 'req')
			print '</th>'
			print '</tr>'
		else:
			print m
	if opt.w:
		print '</table>'

